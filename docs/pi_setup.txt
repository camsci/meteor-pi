# This file lists the shell commands needed to set up a Raspberry Pi to run as a
# Meteor Pi node. It assumes a starting point of a clean Raspbian install.

# ** Expand root partition on SD card

# ** Set up password for Pi

passwd # Set user password
sudo su
passwd # Set root password

# ** Install required raspbian packages

apt-get update
apt-get dist-upgrade
apt-get install gpsd gpsd-clients libjpeg-dev libpng-dev libgsl0-dev vim git qiv screen mplayer libavutil-dev libavcodec-dev libavformat-dev libx264-dev scons firebird2.5-superclassic
dpkg-reconfigure firebird2.5-superclassic # automatically start firebird server
apt-get install libcairo2-dev libcfitsio3-dev libnetpbm10-dev netpbm python-pyfits python-scipy python-imaging python-pip swig
pip install fdb
vim /etc/apt/sources # Uncomment apt-src
apt-get update
apt-get build-dep luvcview

# ** Set Pi to be headless

vim /etc/network/interfaces
# iface eth0 inet static
# address 192.168.1.62
# netmask 255.255.255.0
# gateway 192.168.1.1

reboot

# ** Set up an ssh key for github (will change later to give readonly access)

ssh-keygen
# install ssh key on github
git clone git@github.com:camsci/meteor-pi.git

# ** Build code

cd meteor-pi
ln -s /mnt/harddisk/pi/meteorCam datadir
cd src/gnomonicStack/
./prettymake
cd ../videoProcess/
./prettymake
./prettymake openmax

# ** Set up rpi watchdog

echo "bcm2708_wdog" | sudo tee -a /etc/modules
sudo apt-get install watchdog
sudo update-rc.d watchdog defaults
sudo vim /etc/watchdog.conf
# Uncomment these lines
#max-load-1             = 24
#watchdog-device        = /dev/watchdog

# ** Install astrometry.net

wget http://astrometry.net/downloads/astrometry.net-0.46.tar.bz2
tar xjf astrometry.net-0.46.tar.bz2
cd astrometry.net-0.46
make
make py
make extra
sudo make install
cd /usr/local/astrometry/data
wget http://broiler.astrometry.net/~dstn/4100/index-4113.fits
wget http://broiler.astrometry.net/~dstn/4100/index-4114.fits
wget http://broiler.astrometry.net/~dstn/4100/index-4115.fits
wget http://broiler.astrometry.net/~dstn/4100/index-4116.fits
wget http://broiler.astrometry.net/~dstn/4100/index-4117.fits
wget http://broiler.astrometry.net/~dstn/4100/index-4118.fits
wget http://broiler.astrometry.net/~dstn/4100/index-4119.fits

# ---- DEAD STEPS WHICH ARE NO LONGER NEEDED -----

# ** Set up /etc/fstab to mount external harddisk

vim /etc/fstab
# /dev/sda1	/mnt/harddisk	ext4	defaults	0 0
mkdir -p /mnt/harddisk

